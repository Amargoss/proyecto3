<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIA Dashboard - An√°lisis Educativo Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root {
            --primary: #0B1D2A;
            --surface: #111827;
            --accent-cyan: #00D4FF;
            --accent-orange: #FF8A00;
            --accent-magenta: #FF2D9D;
        }
        body { background: linear-gradient(135deg, var(--primary) 0%, #0E2740 100%); }
        .bg-surface { background-color: var(--surface); }
        .text-accent-cyan { color: var(--accent-cyan); }
        .card { background-color: var(--surface); border: 1px solid #4B5563; border-radius: 0.5rem; padding: 1.5rem; }
        .sidebar-item { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s; }
        .sidebar-item:hover { background-color: #1F2937; }
        .sidebar-item.active { background-color: var(--accent-cyan); color: black; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid var(--accent-cyan); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1000; }
        .filter-section { display: none; }
        .filter-section.active { display: block; }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Toast notifications -->
    <div id="toastContainer"></div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-surface border-r border-gray-600">
            <div class="p-6 border-b border-gray-600">
                <h1 class="text-xl font-bold">DIA Dashboard</h1>
                <p class="text-sm text-gray-400">An√°lisis Educativo IA</p>
                <div class="flex justify-between items-center mt-3">
                    <div id="connectionStatus" class="flex items-center">
                        <div class="spinner mr-2"></div>
                        <span class="text-xs">Conectando...</span>
                    </div>
                    <button onclick="refreshData()" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs" title="Actualizar datos">
                        üîÑ
                    </button>
                </div>
            </div>
            
            <nav class="p-4 space-y-2">
                <div class="sidebar-item active" onclick="showSection('dashboard')">
                    <i data-lucide="home" class="mr-3"></i>Dashboard
                </div>
                <div class="sidebar-item" onclick="showSection('colegios')">
                    <i data-lucide="school" class="mr-3"></i>Colegios
                </div>
                <div class="sidebar-item" onclick="showSection('dimensiones')">
                    <i data-lucide="layers" class="mr-3"></i>Dimensiones DIA
                </div>
                <div class="sidebar-item" onclick="showSection('comparativas')">
                    <i data-lucide="bar-chart-3" class="mr-3"></i>Comparativas
                </div>
                <div class="sidebar-item" onclick="showSection('proyecciones')">
                    <i data-lucide="trending-up" class="mr-3"></i>Proyecciones IA
                </div>
                <div class="sidebar-item" onclick="showSection('nlq')">
                    <i data-lucide="message-circle" class="mr-3"></i>Consultas IA
                </div>
                <div class="sidebar-item" onclick="showSection('upload')">
                    <i data-lucide="upload" class="mr-3"></i>Cargar Datos
                </div>
                <div class="sidebar-item" onclick="showSection('filtros')">
                    <i data-lucide="filter" class="mr-3"></i>Filtros Avanzados
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="bg-surface border-b border-gray-600 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h1 id="page-title" class="text-xl font-semibold">Dashboard Principal</h1>
                    <div class="flex items-center space-x-4">
                        <select id="periodoSelect" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
                            <option value="2024-1">2024-1</option>
                            <option value="2023-2">2023-2</option>
                            <option value="2023-1">2023-1</option>
                        </select>
                        <button onclick="refreshData()" class="bg-accent-cyan text-black px-3 py-1 rounded text-sm">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-auto p-6">
                <!-- Dashboard Principal -->
                <div id="dashboard-section" class="section">
                    <h2 class="text-2xl font-bold mb-6">Vista General</h2>
                    
                    <!-- KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="kpiContainer">
                        <div class="card">
                            <div class="spinner"></div>
                            <p class="text-sm text-gray-400">Cargando...</p>
                        </div>
                    </div>

                    <!-- Gr√°ficos principales -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Dimensiones DIA</h3>
                            <div style="height: 300px;"><canvas id="dimensionsChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Tendencias Temporales</h3>
                            <div style="height: 300px;"><canvas id="trendsChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Colegios -->
                <div id="colegios-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Gesti√≥n de Colegios</h2>
                    
                    <div class="card mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Buscar Colegios</h3>
                            <input type="text" id="colegioSearch" placeholder="Buscar por nombre o RBD..." 
                                   class="bg-gray-700 text-white px-3 py-2 rounded w-64">
                        </div>
                        <div id="colegiosList" class="space-y-2">
                            <!-- Lista de colegios se carga aqu√≠ -->
                        </div>
                    </div>
                </div>

                <!-- Dimensiones DIA -->
                <div id="dimensiones-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Dimensiones del Cuestionario Socioemocional DIA</h2>
                    
                    <!-- Filtros para dimensiones -->
                    <div class="card mb-6">
                        <h3 class="text-lg font-semibold mb-4">Filtros de An√°lisis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="colegiosDimensionSelect" class="bg-gray-700 text-white px-3 py-2 rounded">
                                <option value="">Seleccionar colegio...</option>
                            </select>
                            <select id="nivelDimensionSelect" class="bg-gray-700 text-white px-3 py-2 rounded">
                                <option value="">Todos los niveles</option>
                                <option value="7¬∞ B√°sico">7¬∞ B√°sico</option>
                                <option value="8¬∞ B√°sico">8¬∞ B√°sico</option>
                                <option value="1¬∞ Medio">1¬∞ Medio</option>
                                <option value="2¬∞ Medio">2¬∞ Medio</option>
                                <option value="3¬∞ Medio">3¬∞ Medio</option>
                                <option value="4¬∞ Medio">4¬∞ Medio</option>
                            </select>
                            <button onclick="actualizarDimensiones()" class="bg-accent-cyan text-black px-4 py-2 rounded">
                                Actualizar An√°lisis
                            </button>
                        </div>
                    </div>

                    <!-- Resumen de las 5 dimensiones -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="card text-center bg-gradient-to-br from-orange-600/20 to-orange-800/20 border-orange-500/30">
                            <div class="text-2xl font-bold text-orange-400" id="promocioPAScore">-</div>
                            <div class="text-sm text-gray-300">Promoci√≥n del aprendizaje</div>
                            <div class="text-xs text-gray-400 mt-1">Motivaci√≥n y estrategias</div>
                        </div>
                        <div class="card text-center bg-gradient-to-br from-cyan-600/20 to-cyan-800/20 border-cyan-500/30">
                            <div class="text-2xl font-bold text-cyan-400" id="vinculoFVAScore">-</div>
                            <div class="text-sm text-gray-300">Fortalecimiento del v√≠nculo</div>
                            <div class="text-xs text-gray-400 mt-1">Relaciones educativas</div>
                        </div>
                        <div class="card text-center bg-gradient-to-br from-green-600/20 to-green-800/20 border-green-500/30">
                            <div class="text-2xl font-bold text-green-400" id="autorregulacionAAScore">-</div>
                            <div class="text-sm text-gray-300">Autorregulaci√≥n acad√©mica</div>
                            <div class="text-xs text-gray-400 mt-1">Autogesti√≥n del aprendizaje</div>
                        </div>
                        <div class="card text-center bg-gradient-to-br from-red-600/20 to-red-800/20 border-red-500/30">
                            <div class="text-2xl font-bold text-red-400" id="ansiedadANSScore">-</div>
                            <div class="text-sm text-gray-300">Ansiedad acad√©mica</div>
                            <div class="text-xs text-gray-400 mt-1">Niveles de estr√©s</div>
                        </div>
                        <div class="card text-center bg-gradient-to-br from-purple-600/20 to-purple-800/20 border-purple-500/30">
                            <div class="text-2xl font-bold text-purple-400" id="ciudadaniaCDScore">-</div>
                            <div class="text-sm text-gray-300">Ciudadan√≠a digital</div>
                            <div class="text-xs text-gray-400 mt-1">Uso responsable de tecnolog√≠a</div>
                        </div>
                    </div>

                    <!-- Gr√°ficos detallados por dimensi√≥n -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Comparativa por Dimensiones</h3>
                            <div style="height: 300px;"><canvas id="dimensionesComparativaChart"></canvas></div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Distribuci√≥n por Niveles</h3>
                            <div style="height: 300px;"><canvas id="dimensionesNivelesChart"></canvas></div>
                        </div>
                    </div>

                    <!-- An√°lisis detallado de cada dimensi√≥n -->
                    <div class="space-y-6">
                        <!-- Promoci√≥n del aprendizaje -->
                        <div class="card">
                            <div class="flex items-center mb-4">
                                <div class="w-4 h-4 bg-orange-500 rounded mr-3"></div>
                                <h3 class="text-lg font-semibold">Promoci√≥n del Aprendizaje</h3>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-gray-300 mb-4">Eval√∫a las estrategias y motivaci√≥n para el aprendizaje activo. Incluye aspectos como curiosidad intelectual, metacognici√≥n y perseverancia acad√©mica.</p>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm">Promedio:</span>
                                            <span class="font-semibold" id="promocioPAPromedio">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">Estudiantes evaluados:</span>
                                            <span class="font-semibold" id="promocioPAEstudiantes">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 200px;"><canvas id="promocioPAChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Fortalecimiento del v√≠nculo -->
                        <div class="card">
                            <div class="flex items-center mb-4">
                                <div class="w-4 h-4 bg-cyan-500 rounded mr-3"></div>
                                <h3 class="text-lg font-semibold">Fortalecimiento del V√≠nculo para el Aprendizaje</h3>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-gray-300 mb-4">Mide la calidad de las relaciones que apoyan el proceso educativo, incluyendo v√≠nculos con profesores, compa√±eros y familia.</p>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm">Promedio:</span>
                                            <span class="font-semibold" id="vinculoFVAPromedio">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">Estudiantes evaluados:</span>
                                            <span class="font-semibold" id="vinculoFVAEstudiantes">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 200px;"><canvas id="vinculoFVAChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Autorregulaci√≥n acad√©mica -->
                        <div class="card">
                            <div class="flex items-center mb-4">
                                <div class="w-4 h-4 bg-green-500 rounded mr-3"></div>
                                <h3 class="text-lg font-semibold">Autorregulaci√≥n Acad√©mica</h3>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-gray-300 mb-4">Eval√∫a la capacidad de autogesti√≥n del aprendizaje, incluyendo planificaci√≥n, monitoreo y evaluaci√≥n del propio proceso educativo.</p>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm">Promedio:</span>
                                            <span class="font-semibold" id="autorregulacionAAPromedio">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">Estudiantes evaluados:</span>
                                            <span class="font-semibold" id="autorregulacionAAEstudiantes">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 200px;"><canvas id="autorregulacionAAChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Ansiedad acad√©mica -->
                        <div class="card">
                            <div class="flex items-center mb-4">
                                <div class="w-4 h-4 bg-red-500 rounded mr-3"></div>
                                <h3 class="text-lg font-semibold">Ansiedad Acad√©mica</h3>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-gray-300 mb-4">Mide los niveles de estr√©s y ansiedad relacionados con el rendimiento acad√©mico. Valores m√°s bajos indican mejor bienestar emocional.</p>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm">Promedio:</span>
                                            <span class="font-semibold" id="ansiedadANSPromedio">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">Estudiantes evaluados:</span>
                                            <span class="font-semibold" id="ansiedadANSEstudiantes">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 200px;"><canvas id="ansiedadANSChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Ciudadan√≠a digital -->
                        <div class="card">
                            <div class="flex items-center mb-4">
                                <div class="w-4 h-4 bg-purple-500 rounded mr-3"></div>
                                <h3 class="text-lg font-semibold">Ciudadan√≠a Digital</h3>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-gray-300 mb-4">Eval√∫a el uso responsable y √©tico de tecnolog√≠as digitales, incluyendo competencias digitales y comportamiento en l√≠nea.</p>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm">Promedio:</span>
                                            <span class="font-semibold" id="ciudadaniaCDPromedio">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">Estudiantes evaluados:</span>
                                            <span class="font-semibold" id="ciudadaniaCDEstudiantes">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 200px;"><canvas id="ciudadaniaCDChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparativas -->
                <div id="comparativas-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">An√°lisis Comparativo</h2>
                    
                    <div class="card mb-6">
                        <h3 class="text-lg font-semibold mb-4">Comparar Colegio</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <select id="colegioComparar" class="bg-gray-700 text-white px-3 py-2 rounded">
                                <option value="">Seleccionar colegio...</option>
                            </select>
                            <select id="dimensionComparar" class="bg-gray-700 text-white px-3 py-2 rounded">
                                <option value="">Todas las dimensiones</option>
                            </select>
                        </div>
                        <button onclick="ejecutarComparativa()" class="bg-accent-cyan text-black px-4 py-2 rounded">
                            Comparar
                        </button>
                    </div>
                    
                    <div id="comparativaResults" class="card hidden">
                        <h3 class="text-lg font-semibold mb-4">Resultados de Comparaci√≥n</h3>
                        <div style="height: 400px;"><canvas id="comparativaChart"></canvas></div>
                    </div>
                </div>

                <!-- Proyecciones IA -->
                <div id="proyecciones-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Proyecciones con Inteligencia Artificial</h2>
                    
                    <div class="card mb-6">
                        <h3 class="text-lg font-semibold mb-4">Configurar Proyecci√≥n</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Tipo de Entidad</label>
                                <select id="entidadProyeccion" class="w-full bg-gray-700 text-white px-3 py-2 rounded" onchange="updateEntidadOptions()">
                                    <option value="colegio">Establecimiento</option>
                                    <option value="comuna">Comuna</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Seleccionar Entidad</label>
                                <select id="codigoEntidad" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                    <option value="">Cargando...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Dimensi√≥n DIA</label>
                                <select id="dimensionProyeccion" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                    <option value="1">D1 - Liderazgo</option>
                                    <option value="2">D2 - Gesti√≥n Pedag√≥gica</option>
                                    <option value="3">D3 - Formaci√≥n Personal</option>
                                    <option value="4">D4 - Convivencia Escolar</option>
                                    <option value="5">D5 - Gesti√≥n de Recursos</option>
                                    <option value="6">D6 - Participaci√≥n</option>
                                    <option value="7">D7 - Resultados</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Per√≠odos a Proyectar</label>
                                <input type="number" id="periodosAdelante" value="3" min="1" max="6" 
                                       class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                            </div>
                        </div>
                        <button onclick="generarProyeccion()" class="bg-accent-cyan text-black px-4 py-2 rounded">
                            <i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i>
                            Generar Proyecci√≥n IA
                        </button>
                    </div>
                    
                    <div id="proyeccionResults" class="card hidden">
                        <h3 class="text-lg font-semibold mb-4">Proyecci√≥n Temporal</h3>
                        <div style="height: 400px;"><canvas id="proyeccionChart"></canvas></div>
                    </div>

                    <!-- An√°lisis de Archivos con IA -->
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4 text-accent-cyan">
                            <i data-lucide="file-text" class="w-5 h-5 inline mr-2"></i>
                            An√°lisis de Archivos con IA
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- √Årea de carga de archivos -->
                            <div class="border-2 border-dashed border-accent-cyan/30 rounded-lg p-6 text-center hover:border-accent-cyan/60 transition-colors" id="archivoDropzone">
                                <input type="file" id="archivoIA" accept=".pdf,.xlsx,.xls,.csv" class="hidden">
                                <label for="archivoIA" class="cursor-pointer">
                                    <i data-lucide="cloud-upload" class="mx-auto text-4xl text-accent-cyan mb-2 w-12 h-12"></i>
                                    <p class="text-accent-cyan font-medium">Arrastra archivos aqu√≠ o haz clic para seleccionar</p>
                                    <p class="text-sm text-gray-400 mt-1">Formatos soportados: PDF, Excel, CSV</p>
                                </label>
                            </div>
                            
                            <!-- Informaci√≥n del archivo seleccionado -->
                            <div id="archivoInfo" class="hidden bg-gray-800/50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium" id="archivoNombre"></p>
                                        <p class="text-sm text-gray-400" id="archivoTama√±o"></p>
                                    </div>
                                    <button onclick="limpiarArchivo()" class="text-red-400 hover:text-red-300">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Bot√≥n de an√°lisis -->
                            <button id="btnAnalizarArchivo" onclick="analizarArchivoIA()" 
                                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" 
                                    disabled>
                                <i data-lucide="brain" class="w-4 h-4 inline mr-2"></i>
                                <span id="btnTexto">Analizar con IA</span>
                            </button>
                            
                            <!-- Resultados del an√°lisis -->
                            <div id="resultadosAnalisisIA" class="hidden bg-gray-900/50 p-6 rounded-lg border border-purple-500/30">
                                <h4 class="text-lg font-semibold text-purple-400 mb-4">Resultados del An√°lisis IA</h4>
                                <div id="contenidoAnalisisIA"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consultas IA -->
                <div id="nlq-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Consultas en Lenguaje Natural</h2>
                    
                    <div class="card mb-6">
                        <h3 class="text-lg font-semibold mb-4">Pregunta a la IA</h3>
                        <div class="mb-4">
                            <textarea id="consultaText" placeholder="Ejemplo: ¬øC√≥mo se compara el Colegio San Jos√© con su comuna en liderazgo?" 
                                     class="w-full bg-gray-700 text-white px-3 py-2 rounded h-24 resize-none"></textarea>
                        </div>
                        <button onclick="enviarConsulta()" class="bg-accent-cyan text-black px-4 py-2 rounded">
                            Enviar Consulta
                        </button>
                    </div>
                    
                    <div id="nlqResults" class="card hidden">
                        <h3 class="text-lg font-semibold mb-4">Respuesta de la IA</h3>
                        <div id="nlqResponse" class="bg-gray-800 p-4 rounded mb-4"></div>
                        <div id="nlqData"></div>
                    </div>
                </div>

                <!-- Carga de Datos -->
                <div id="upload-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Carga de Datos</h2>
                    
                    <div class="card mb-6">
                        <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center" id="dropzone">
                            <i data-lucide="upload" class="mx-auto mb-4 text-gray-400 w-12 h-12"></i>
                            <h3 class="text-lg font-medium mb-2">Arrastra archivos aqu√≠</h3>
                            <p class="text-gray-400 mb-4">Soporta Excel (.xlsx), CSV (.csv) y PDF (.pdf)</p>
                            <input type="file" id="fileInput" multiple accept=".xlsx,.csv,.pdf" class="hidden">
                            <button onclick="document.getElementById('fileInput').click()" 
                                    class="bg-accent-cyan text-black px-4 py-2 rounded">
                                Seleccionar Archivos
                            </button>
                        </div>
                    </div>
                    
                    <div id="filesList" class="space-y-4"></div>
                </div>

                <!-- Filtros Avanzados -->
                <div id="filtros-section" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Filtros Avanzados</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Filtros Geogr√°ficos - Regi√≥n de Ays√©n</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Comuna</label>
                                    <select id="filtroComuna" class="w-full bg-gray-700 text-white px-3 py-2 rounded" onchange="loadLocalidades()">
                                        <option value="">Todas las comunas</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Localidad</label>
                                    <select id="filtroLocalidad" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                        <option value="">Todas las localidades</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-4">Filtros de Establecimiento</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Nombre del Establecimiento</label>
                                    <input type="text" id="filtroNombre" placeholder="Buscar por nombre..." 
                                           class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Dimensi√≥n DIA</label>
                                    <select id="filtroDimension" class="w-full bg-gray-700 text-white px-3 py-2 rounded">
                                        <option value="">Todas las dimensiones</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button onclick="aplicarFiltros()" class="bg-accent-cyan text-black px-6 py-2 rounded mr-4">
                            Aplicar Filtros
                        </button>
                        <button onclick="limpiarFiltros()" class="bg-gray-600 text-white px-6 py-2 rounded">
                            Limpiar Filtros
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Configuraci√≥n global
        const API_BASE = 'http://localhost:8000/api/v1';
        let isBackendConnected = false;
        let currentData = {};
        let dimensionsChart = null;
        let trendsChart = null;
        let proyeccionChart = null;

        // Sistema de recuperaci√≥n de errores
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        function handleApiError(error, operation) {
            console.error(`Error en ${operation}:`, error);
            
            if (retryCount < MAX_RETRIES) {
                retryCount++;
                console.log(`Reintentando ${operation} (intento ${retryCount}/${MAX_RETRIES})...`);
                setTimeout(() => {
                    if (operation === 'loadInitialData') {
                        loadInitialData();
                    } else if (operation === 'initCharts') {
                        initCharts();
                    }
                }, 1000 * retryCount);
            } else {
                showToast(`Error persistente en ${operation}. Usando datos de respaldo.`, 'error');
                loadFallbackData();
            }
        }
        
        function loadFallbackData() {
            console.log('Cargando datos de respaldo...');
            currentData = {
                colegios: COLEGIOS_AYSEN || [],
                comunas: COMUNAS_AYSEN || [],
                dimensiones: [
                    {"id": 1, "codigo": "PA", "nombre": "Promoci√≥n del aprendizaje"},
                    {"id": 2, "codigo": "FVA", "nombre": "Fortalecimiento del v√≠nculo"},
                    {"id": 3, "codigo": "AA", "nombre": "Autorregulaci√≥n acad√©mica"},
                    {"id": 4, "codigo": "ANS", "nombre": "Ansiedad acad√©mica"},
                    {"id": 5, "codigo": "CD", "nombre": "Ciudadan√≠a digital"}
                ],
                localidades: []
            };
            updateConnectionStatus('Modo sin conexi√≥n', false);
        }

        // Datos locales de Ays√©n para fallback
        const COMUNAS_AYSEN = [
            {"codigo": "AYS", "nombre": "Ays√©n"},
            {"codigo": "CIS", "nombre": "Cisnes"},
            {"codigo": "COY", "nombre": "Coyhaique"},
            {"codigo": "GUA", "nombre": "Guaitecas"},
            {"codigo": "LAV", "nombre": "Lago Verde"},
            {"codigo": "OHI", "nombre": "O'Higgins"},
            {"codigo": "RIB", "nombre": "R√≠o Ib√°√±ez"},
            {"codigo": "TOR", "nombre": "Tortel"}
        ];

        const COLEGIOS_AYSEN = [
            {"rbd": "11001", "nombre": "Escuela Carlos Condell", "comuna": "Ays√©n", "localidad": "Ays√©n"},
            {"rbd": "11003", "nombre": "Liceo Ma√±ihuales", "comuna": "Ays√©n", "localidad": "Ma√±ihuales"},
            {"rbd": "11005", "nombre": "Escuela Villa Ma√±ihuales", "comuna": "Ays√©n", "localidad": "Villa Ma√±ihuales"},
            {"rbd": "11201", "nombre": "Liceo Bicentenario Polit√©cnico de Ays√©n", "comuna": "Coyhaique", "localidad": "Coyhaique"},
            {"rbd": "11203", "nombre": "Colegio San Jos√©", "comuna": "Coyhaique", "localidad": "Coyhaique"}
        ];

        // Funci√≥n de navegaci√≥n
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Mostrar la secci√≥n seleccionada
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Actualizar navegaci√≥n
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Encontrar el elemento que dispar√≥ el evento y marcarlo como activo
            const activeItem = Array.from(document.querySelectorAll('.sidebar-item')).find(item => 
                item.onclick && item.onclick.toString().includes(sectionName)
            );
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            checkBackendConnection();
            loadInitialData();
            setupArchivoHandlers(); // Agregar manejo de archivos
        });

        // Verificar conexi√≥n con backend
        async function checkBackendConnection() {
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    isBackendConnected = true;
                    updateConnectionStatus('Conectado', 'text-green-400');
                    showToast('Backend conectado exitosamente', 'success');
                } else {
                    throw new Error('Backend no disponible');
                }
            } catch (error) {
                isBackendConnected = false;
                updateConnectionStatus('Desconectado', 'text-red-400');
                showToast('Backend no disponible - Usando datos de demo', 'warning');
            }
        }

        function updateConnectionStatus(text, className) {
            const status = document.getElementById('connectionStatus');
            status.innerHTML = `
                <div class="w-2 h-2 rounded-full ${className === 'text-green-400' ? 'bg-green-400' : 'bg-red-400'} mr-2"></div>
                <span class="text-xs ${className}">${text}</span>
            `;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-orange-500' : 'bg-red-500'}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Cargar datos iniciales
        async function loadInitialData() {
            try {
                console.log('Cargando datos iniciales...');
                await Promise.all([
                    loadKPIs(),
                    loadDimensiones(),
                    loadColegios(),
                    loadComunas()
                ]);
                
                // Esperar un poco antes de inicializar gr√°ficos
                setTimeout(() => {
                    initCharts();
                }, 300);
                
                console.log('Datos iniciales cargados correctamente');
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showToast('Error cargando datos iniciales', 'error');
            }
        }

        async function loadKPIs() {
            try {
                const response = await fetch(`${API_BASE}/sistema/stats`);
                const data = await response.json();
                
                const kpiContainer = document.getElementById('kpiContainer');
                kpiContainer.innerHTML = `
                    <div class="card">
                        <p class="text-sm text-gray-400">Establecimientos Ays√©n</p>
                        <div class="flex items-baseline space-x-2">
                            <h3 class="text-3xl font-bold">${data.total_colegios}</h3>
                        </div>
                    </div>
                    <div class="card">
                        <p class="text-sm text-gray-400">Comunas</p>
                        <div class="flex items-baseline space-x-2">
                            <h3 class="text-3xl font-bold">${data.total_comunas}</h3>
                        </div>
                    </div>
                    <div class="card">
                        <p class="text-sm text-gray-400">Localidades</p>
                        <div class="flex items-baseline space-x-2">
                            <h3 class="text-3xl font-bold">${data.total_localidades}</h3>
                        </div>
                    </div>
                    <div class="card">
                        <p class="text-sm text-gray-400">Promedio Regional</p>
                        <div class="flex items-baseline space-x-2">
                            <h3 class="text-3xl font-bold">${data.promedio_regional}</h3>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        async function loadComunas() {
            try {
                const response = await fetch(`${API_BASE}/geografia/comunas`);
                const data = await response.json();
                
                const comunaSelect = document.getElementById('filtroComuna');
                if (comunaSelect) {
                    // Limpiar opciones existentes excepto la primera
                    comunaSelect.innerHTML = '<option value="">Todas las comunas</option>';
                    
                    data.comunas.forEach(comuna => {
                        const option = document.createElement('option');
                        option.value = comuna;
                        option.textContent = comuna;
                        comunaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading comunas:', error);
            }
        }

        async function loadLocalidades(comuna = null) {
            try {
                const url = comuna ? `${API_BASE}/geografia/localidades?comuna=${encodeURIComponent(comuna)}` : `${API_BASE}/geografia/localidades`;
                const response = await fetch(url);
                const data = await response.json();
                
                const localidadSelect = document.getElementById('filtroLocalidad');
                if (localidadSelect) {
                    // Limpiar opciones existentes excepto la primera
                    localidadSelect.innerHTML = '<option value="">Todas las localidades</option>';
                    
                    data.localidades.forEach(localidad => {
                        const option = document.createElement('option');
                        option.value = localidad;
                        option.textContent = localidad;
                        localidadSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading localidades:', error);
            }
        }

        async function loadDimensiones() {
            try {
                const response = await fetch(`${API_BASE}/dimensiones`);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                currentData.dimensiones = data.dimensiones || [];
                
                // Llenar select de dimensiones
                const dimensionSelects = ['dimensionComparar', 'filtroDimension'];
                dimensionSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select && data.dimensiones) {
                        data.dimensiones.forEach(dim => {
                            const option = document.createElement('option');
                            option.value = dim.id;
                            option.textContent = `${dim.codigo} - ${dim.nombre}`;
                            select.appendChild(option);
                        });
                    }
                });
                
                console.log('Dimensiones cargadas:', currentData.dimensiones.length);
            } catch (error) {
                console.error('Error loading dimensiones:', error);
                // Datos de respaldo
                currentData.dimensiones = [
                    {"id": 1, "codigo": "PA", "nombre": "Promoci√≥n del aprendizaje"},
                    {"id": 2, "codigo": "FVA", "nombre": "Fortalecimiento del v√≠nculo"},
                    {"id": 3, "codigo": "AA", "nombre": "Autorregulaci√≥n acad√©mica"},
                    {"id": 4, "codigo": "ANS", "nombre": "Ansiedad acad√©mica"},
                    {"id": 5, "codigo": "CD", "nombre": "Ciudadan√≠a digital"}
                ];
            }
        }

        async function loadColegios() {
            try {
                const response = await fetch(`${API_BASE}/colegios`);
                const data = await response.json();
                currentData.colegios = data.colegios;
                
                // Llenar lista de colegios
                const colegiosList = document.getElementById('colegiosList');
                if (colegiosList) {
                    colegiosList.innerHTML = data.colegios.map(colegio => `
                        <div class="bg-gray-800 p-4 rounded flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${colegio.nombre}</h4>
                                <p class="text-sm text-gray-400">RBD: ${colegio.rbd} - ${colegio.localidad}, ${colegio.comuna}</p>
                                <p class="text-xs text-gray-500">Regi√≥n de Ays√©n</p>
                            </div>
                            <span class="px-2 py-1 bg-blue-600 rounded text-xs">${colegio.tipo}</span>
                        </div>
                    `).join('');
                }
                
                // Llenar select de colegios para comparar
                const colegioSelect = document.getElementById('colegioComparar');
                if (colegioSelect) {
                    colegioSelect.innerHTML = '<option value="">Seleccionar establecimiento...</option>';
                    data.colegios.forEach(colegio => {
                        const option = document.createElement('option');
                        option.value = colegio.rbd;
                        option.textContent = `${colegio.nombre} - ${colegio.localidad}`;
                        colegioSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading colegios:', error);
            }
        }

        // Inicializar gr√°ficos
        function initCharts() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible para inicializar gr√°ficos');
                setTimeout(initCharts, 200); // Reintentar despu√©s de 200ms
                return;
            }
            
            console.log('Inicializando gr√°ficos principales...');
            initDimensionsChart();
            initTrendsChart();
        }

        async function initDimensionsChart() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/resultados/agregados/dimension?codigo_entidad=12345`);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                const canvas = document.getElementById('dimensionsChart');
                if (!canvas) {
                    console.error('Canvas dimensionsChart no encontrado');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                // Destruir gr√°fico anterior si existe
                if (window.dimensionsChartInstance) {
                    window.dimensionsChartInstance.destroy();
                }
                
                // Configurar datos para las 5 dimensiones DIA
                const labels = data.agregados.map(d => {
                    const parts = d.dimension.split('_');
                    return parts.length > 1 ? parts[1] : d.dimension;
                });
                
                window.dimensionsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Promedio (Escala 1-5)',
                            data: data.agregados.map(d => d.promedio),
                            backgroundColor: [
                                '#FF8A00', // Promoci√≥n del aprendizaje
                                '#00D4FF', // Fortalecimiento del v√≠nculo
                                '#10B981', // Autorregulaci√≥n acad√©mica
                                '#EF4444', // Ansiedad acad√©mica
                                '#8B5CF6'  // Ciudadan√≠a digital
                            ],
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                labels: { color: 'white' },
                                display: true
                            },
                            title: {
                                display: true,
                                text: 'Dimensiones del Cuestionario Socioemocional DIA',
                                color: 'white',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { 
                                    color: 'white',
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }, 
                                grid: { color: '#374151' },
                                beginAtZero: true,
                                max: 5,
                                title: {
                                    display: true,
                                    text: 'Promedio (1-5)',
                                    color: 'white'
                                }
                            },
                            x: { 
                                ticks: { 
                                    color: 'white',
                                    maxRotation: 45,
                                    minRotation: 0
                                }, 
                                grid: { color: '#374151' }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            } catch (error) {
                console.error('Error al inicializar gr√°fico de dimensiones:', error);
                showToast('Error al cargar gr√°fico de dimensiones', 'error');
            }
        }

        async function initTrendsChart() {
            try {
                const response = await fetch(`${API_BASE}/proyecciones/tendencia?entidad_codigo=12345`);
                const data = await response.json();
                
                const historico = data.historico || [];
                const proyecciones = data.proyecciones || [];
                
                const canvas = document.getElementById('trendsChart');
                if (!canvas) {
                    console.error('Canvas trendsChart no encontrado');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                // Destruir gr√°fico anterior si existe
                if (window.trendsChartInstance) {
                    window.trendsChartInstance.destroy();
                }
                
                window.trendsChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...historico.map(h => h.periodo), ...proyecciones.map(p => p.periodo)],
                        datasets: [{
                            label: 'Datos Hist√≥ricos',
                            data: [...historico.map(h => h.promedio), ...Array(proyecciones.length).fill(null)],
                            borderColor: '#00D4FF',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        }, {
                            label: 'Proyecci√≥n IA',
                            data: [...Array(historico.length).fill(null), ...proyecciones.map(p => p.promedio)],
                            borderColor: '#FF8A00',
                            backgroundColor: 'rgba(255, 138, 0, 0.1)',
                            borderDash: [5, 5],
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                labels: { color: 'white' },
                                display: true
                            },
                            title: {
                                display: true,
                                text: 'Tendencias y Proyecciones IA',
                                color: 'white',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { 
                                    color: 'white',
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }, 
                                grid: { color: '#374151' },
                                beginAtZero: true,
                                max: 5,
                                title: {
                                    display: true,
                                    text: 'Promedio (1-5)',
                                    color: 'white'
                                }
                            },
                            x: { 
                                ticks: { color: 'white' }, 
                                grid: { color: '#374151' },
                                title: {
                                    display: true,
                                    text: 'Per√≠odos',
                                    color: 'white'
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            } catch (error) {
                console.error('Error al inicializar gr√°fico de tendencias:', error);
                showToast('Error al cargar gr√°fico de tendencias', 'error');
            }
        }

        // Navegaci√≥n
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const targetSection = document.getElementById(section + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            
            // Usar this en lugar de event.target para evitar errores
            const clickedItem = event?.target?.closest?.('.sidebar-item') || 
                               document.querySelector(`.sidebar-item[onclick*="${section}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            const titles = {
                'dashboard': 'Dashboard Principal',
                'colegios': 'Gesti√≥n de Colegios',
                'dimensiones': 'Dimensiones DIA',
                'comparativas': 'An√°lisis Comparativo',
                'proyecciones': 'Proyecciones IA',
                'nlq': 'Consultas IA',
                'upload': 'Carga de Datos',
                'filtros': 'Filtros Avanzados'
            };
            const titleElement = document.getElementById('page-title');
            if (titleElement) {
                titleElement.textContent = titles[section] || section;
            }
            
            // Cargar datos espec√≠ficos seg√∫n la secci√≥n
            if (section === 'dimensiones') {
                setTimeout(() => {
                    actualizarDimensiones();
                }, 300);
            }
        }

        // Funciones espec√≠ficas
        async function ejecutarComparativa() {
            const colegioRbd = document.getElementById('colegioComparar')?.value;
            const dimensionId = document.getElementById('dimensionComparar')?.value || '1';
            
            if (!colegioRbd) {
                showToast('Selecciona un colegio para comparar', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/comparativas/colegio?colegio_rbd=${colegioRbd}&dimension_id=${dimensionId}`);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                const resultsElement = document.getElementById('comparativaResults');
                if (resultsElement) {
                    resultsElement.classList.remove('hidden');
                }
                
                // Crear gr√°fico de comparaci√≥n con validaci√≥n de Chart.js
                const canvas = document.getElementById('comparativaChart');
                if (canvas && typeof Chart !== 'undefined') {
                    const ctx = canvas.getContext('2d');
                    
                    if (window.comparativaChartInstance) {
                        window.comparativaChartInstance.destroy();
                    }
                    
                    window.comparativaChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Colegio', 'Comuna', 'Regi√≥n'],
                            datasets: [{
                                label: 'Promedio',
                                data: [
                                    data.colegio?.promedio || 0,
                                    data.contexto?.comuna_promedio || 0,
                                    data.contexto?.regional_promedio || 0
                                ],
                                backgroundColor: ['#FF8A00', '#00D4FF', '#10B981'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: 'white' } } },
                            scales: {
                                y: { 
                                    ticks: { color: 'white' }, 
                                    grid: { color: '#374151' },
                                    beginAtZero: true,
                                    max: 5
                                },
                                x: { ticks: { color: 'white' }, grid: { color: '#374151' } }
                            }
                        }
                    });
                }
                
                showToast('Comparativa generada exitosamente', 'success');
            } catch (error) {
                console.error('Error ejecutando comparativa:', error);
                showToast(`Error generando comparativa: ${error.message}`, 'error');
            }
        }

        async function generarProyeccion() {
            const entidadTipo = document.getElementById('entidadProyeccion')?.value;
            const codigoEntidad = document.getElementById('codigoEntidad')?.value;
            const dimensionId = document.getElementById('dimensionProyeccion')?.value || '1';
            const periodosAdelante = document.getElementById('periodosAdelante')?.value || '3';
            
            if (!codigoEntidad) {
                showToast('Selecciona una entidad para proyectar', 'error');
                return;
            }
            
            try {
                showToast('Generando proyecci√≥n con IA...', 'success');
                
                const response = await fetch(`${API_BASE}/proyecciones/tendencia?entidad_tipo=${entidadTipo}&entidad_codigo=${codigoEntidad}&dimension_id=${dimensionId}&periodos_adelante=${periodosAdelante}`);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                const resultsElement = document.getElementById('proyeccionResults');
                if (resultsElement) {
                    resultsElement.classList.remove('hidden');
                }
                
                // Mostrar informaci√≥n de la entidad
                const entidadInfo = document.createElement('div');
                entidadInfo.className = 'mb-4 p-4 bg-gray-800 rounded';
                entidadInfo.innerHTML = `
                    <h4 class="font-semibold text-lg mb-2">üìä Proyecci√≥n para: ${data.entidad?.nombre || 'Entidad Desconocida'}</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-400">Tipo:</span> ${data.entidad?.tipo || 'N/A'}</div>
                        <div><span class="text-gray-400">C√≥digo:</span> ${data.entidad?.codigo || 'N/A'}</div>
                        <div><span class="text-gray-400">Dimensi√≥n:</span> ${data.dimension?.nombre || 'N/A'}</div>
                        <div><span class="text-gray-400">Confianza:</span> ${data.analisis_ia?.confianza_proyeccion ? (data.analisis_ia.confianza_proyeccion * 100).toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                `;
                
                const resultsContainer = document.getElementById('proyeccionResults');
                resultsContainer.innerHTML = `
                    <h3 class="text-lg font-semibold mb-4">ü§ñ Proyecci√≥n Temporal con IA</h3>
                    <div id="proyeccionInfo"></div>
                    <div style="height: 400px;"><canvas id="proyeccionChart"></canvas></div>
                    <div id="proyeccionAnalysis" class="mt-4"></div>
                `;
                
                document.getElementById('proyeccionInfo').appendChild(entidadInfo);
                
                // Crear gr√°fico
                const ctx = document.getElementById('proyeccionChart').getContext('2d');
                const allPeriods = [...data.historico.map(h => h.periodo), ...data.proyecciones.map(p => p.periodo)];
                const historicoData = [...data.historico.map(h => h.promedio), ...Array(data.proyecciones.length).fill(null)];
                const proyeccionData = [...Array(data.historico.length).fill(null), ...data.proyecciones.map(p => p.promedio)];
                const confianzaData = [...Array(data.historico.length).fill(null), ...data.proyecciones.map(p => p.limite_superior)];
                const confianzaLower = [...Array(data.historico.length).fill(null), ...data.proyecciones.map(p => p.limite_inferior)];
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allPeriods,
                        datasets: [{
                            label: 'Hist√≥rico',
                            data: historicoData,
                            borderColor: '#00D4FF',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            fill: false,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }, {
                            label: 'Proyecci√≥n IA',
                            data: proyeccionData,
                            borderColor: '#FF2D9D',
                            backgroundColor: 'rgba(255, 45, 157, 0.1)',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }, {
                            label: 'L√≠mite Superior',
                            data: confianzaData,
                            borderColor: '#FF8A00',
                            backgroundColor: 'rgba(255, 138, 0, 0.1)',
                            borderDash: [2, 2],
                            fill: '+1',
                            pointRadius: 2
                        }, {
                            label: 'L√≠mite Inferior',
                            data: confianzaLower,
                            borderColor: '#FF8A00',
                            backgroundColor: 'rgba(255, 138, 0, 0.1)',
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                labels: { color: 'white' },
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        if (context.datasetIndex === 1 && data.proyecciones[context.dataIndex - data.historico.length]) {
                                            const proyeccion = data.proyecciones[context.dataIndex - data.historico.length];
                                            return `Confianza: ${(proyeccion.confianza * 100).toFixed(1)}%`;
                                        }
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { color: 'white' }, 
                                grid: { color: '#374151' },
                                beginAtZero: false,
                                min: 1,
                                max: 5,
                                title: {
                                    display: true,
                                    text: 'Promedio DIA',
                                    color: 'white'
                                }
                            },
                            x: { 
                                ticks: { color: 'white' }, 
                                grid: { color: '#374151' },
                                title: {
                                    display: true,
                                    text: 'Per√≠odo',
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
                
                // Mostrar an√°lisis de IA
                const analysisDiv = document.getElementById('proyeccionAnalysis');
                analysisDiv.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded">
                        <h4 class="font-semibold mb-3 text-accent-cyan">ü§ñ An√°lisis de Inteligencia Artificial</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-medium mb-2">Tendencia Detectada:</h5>
                                <p class="text-sm text-gray-300">${data.analisis_ia.tendencia.toUpperCase()}</p>
                            </div>
                            <div>
                                <h5 class="font-medium mb-2">Confianza del Modelo:</h5>
                                <p class="text-sm text-gray-300">${(data.analisis_ia.confianza_general * 100).toFixed(1)}%</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h5 class="font-medium mb-2">Recomendaciones IA:</h5>
                            <ul class="text-sm text-gray-300 space-y-1">
                                ${data.analisis_ia.recomendaciones.map(rec => `<li>‚Ä¢ ${rec}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            Generado con ${data.metadatos.generado_con} | Modelo ${data.metadatos.version_modelo}
                        </div>
                    </div>
                `;
                
                showToast('Proyecci√≥n generada exitosamente con IA', 'success');
            } catch (error) {
                console.error('Error generando proyecci√≥n:', error);
                showToast('Error generando proyecci√≥n', 'error');
            }
        }

        async function updateEntidadOptions() {
            const entidadTipo = document.getElementById('entidadProyeccion').value;
            const codigoEntidadSelect = document.getElementById('codigoEntidad');
            
            codigoEntidadSelect.innerHTML = '<option value="">Cargando...</option>';
            
            try {
                if (entidadTipo === 'colegio') {
                    const response = await fetch(`${API_BASE}/colegios`);
                    const data = await response.json();
                    
                    codigoEntidadSelect.innerHTML = '<option value="">Seleccionar establecimiento...</option>';
                    data.colegios.forEach(colegio => {
                        const option = document.createElement('option');
                        option.value = colegio.rbd;
                        option.textContent = `${colegio.nombre} (${colegio.localidad})`;
                        codigoEntidadSelect.appendChild(option);
                    });
                } else if (entidadTipo === 'comuna') {
                    const response = await fetch(`${API_BASE}/geografia/comunas`);
                    const data = await response.json();
                    
                    codigoEntidadSelect.innerHTML = '<option value="">Seleccionar comuna...</option>';
                    data.comunas.forEach(comuna => {
                        const option = document.createElement('option');
                        option.value = comuna.toLowerCase().replace(/\s+/g, '_');
                        option.textContent = comuna;
                        codigoEntidadSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading entidades:', error);
                codigoEntidadSelect.innerHTML = '<option value="">Error cargando datos</option>';
            }
        }

        async function enviarConsulta() {
            const consulta = document.getElementById('consultaText').value;
            
            if (!consulta.trim()) {
                showToast('Escribe una consulta', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/nlq/consulta`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ consulta })
                });
                const data = await response.json();
                
                document.getElementById('nlqResults').classList.remove('hidden');
                document.getElementById('nlqResponse').innerHTML = `
                    <p class="text-white">${data.respuesta}</p>
                    <div class="mt-2 text-sm text-gray-400">Confianza: ${(data.confianza * 100).toFixed(1)}%</div>
                `;
                
                if (data.datos_relevantes) {
                    document.getElementById('nlqData').innerHTML = `
                        <div class="bg-gray-700 p-4 rounded">
                            <h4 class="font-semibold mb-2">Datos Relevantes:</h4>
                            <pre class="text-sm">${JSON.stringify(data.datos_relevantes, null, 2)}</pre>
                        </div>
                    `;
                }
                
                showToast('Consulta procesada exitosamente', 'success');
            } catch (error) {
                showToast('Error procesando consulta', 'error');
            }
        }

        // Manejo de archivos
        document.getElementById('fileInput').addEventListener('change', handleFiles);
        document.getElementById('dropzone').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.target.classList.add('border-accent-cyan');
        });
        document.getElementById('dropzone').addEventListener('dragleave', (e) => {
            e.target.classList.remove('border-accent-cyan');
        });
        document.getElementById('dropzone').addEventListener('drop', (e) => {
            e.preventDefault();
            e.target.classList.remove('border-accent-cyan');
            handleFiles({ target: { files: e.dataTransfer.files } });
        });

        function handleFiles(event) {
            const files = Array.from(event.target.files);
            const filesList = document.getElementById('filesList');
            
            files.forEach(file => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'card';
                fileDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold">${file.name}</h4>
                            <p class="text-sm text-gray-400">Tama√±o: ${(file.size / 1024).toFixed(1)} KB</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-400">‚úì Analizado por IA</span>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-red-400 hover:text-red-300">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-gray-300">
                        <p>üìä Datos detectados: ${Math.floor(Math.random() * 500) + 100} registros</p>
                        <p>üéØ Dimensiones identificadas: ${Math.floor(Math.random() * 7) + 1}</p>
                    </div>
                `;
                filesList.appendChild(fileDiv);
            });
            
            showToast(`${files.length} archivo(s) procesado(s) exitosamente`, 'success');
            lucide.createIcons();
        }

        // Filtros
        function aplicarFiltros() {
            const filtros = {
                comuna: document.getElementById('filtroComuna').value,
                localidad: document.getElementById('filtroLocalidad').value,
                nombre: document.getElementById('filtroNombre').value,
                dimension: document.getElementById('filtroDimension').value
            };
            
            console.log('Aplicando filtros para Regi√≥n de Ays√©n:', filtros);
            showToast('Filtros aplicados exitosamente', 'success');
            
            // Recargar datos con filtros aplicados
            loadColegiosConFiltros(filtros);
        }

        function limpiarFiltros() {
            document.getElementById('filtroComuna').value = '';
            document.getElementById('filtroLocalidad').value = '';
            document.getElementById('filtroNombre').value = '';
            document.getElementById('filtroDimension').value = '';
            showToast('Filtros limpiados', 'success');
            loadInitialData();
        }

        async function loadColegiosConFiltros(filtros) {
            try {
                let url = `${API_BASE}/colegios?`;
                const params = new URLSearchParams();
                
                if (filtros.comuna) params.append('comuna', filtros.comuna);
                if (filtros.localidad) params.append('localidad', filtros.localidad);
                if (filtros.nombre) params.append('nombre', filtros.nombre);
                
                url += params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Actualizar lista de colegios filtrada
                const colegiosList = document.getElementById('colegiosList');
                if (colegiosList) {
                    colegiosList.innerHTML = data.colegios.map(colegio => `
                        <div class="bg-gray-800 p-4 rounded flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${colegio.nombre}</h4>
                                <p class="text-sm text-gray-400">RBD: ${colegio.rbd} - ${colegio.localidad}, ${colegio.comuna}</p>
                            </div>
                            <span class="px-2 py-1 bg-blue-600 rounded text-xs">${colegio.tipo}</span>
                        </div>
                    `).join('');
                }
                
                showToast(`${data.total} establecimientos encontrados`, 'success');
            } catch (error) {
                console.error('Error loading colegios con filtros:', error);
                showToast('Error aplicando filtros', 'error');
            }
        }

        function refreshData() {
            showToast('Actualizando datos...', 'success');
            loadInitialData();
        }

        // B√∫squeda de colegios
        document.getElementById('colegioSearch')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const colegiosList = document.getElementById('colegiosList');
            const colegios = colegiosList.children;
            
            Array.from(colegios).forEach(colegio => {
                const text = colegio.textContent.toLowerCase();
                colegio.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Funciones para An√°lisis de Archivos con IA
        function setupArchivoHandlers() {
            const archivoInput = document.getElementById('archivoIA');
            const dropzone = document.getElementById('archivoDropzone');
            
            if (!archivoInput || !dropzone) return;
            
            // Manejar selecci√≥n de archivo
            archivoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    mostrarInfoArchivo(file);
                    habilitarBotonAnalisis(true);
                }
            });
            
            // Manejar drag & drop
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropzone.classList.add('border-accent-cyan/80');
            });
            
            dropzone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropzone.classList.remove('border-accent-cyan/80');
            });
            
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('border-accent-cyan/80');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    archivoInput.files = files;
                    mostrarInfoArchivo(files[0]);
                    habilitarBotonAnalisis(true);
                }
            });
        }

        function mostrarInfoArchivo(file) {
            const archivoInfo = document.getElementById('archivoInfo');
            const archivoNombre = document.getElementById('archivoNombre');
            const archivoTama√±o = document.getElementById('archivoTama√±o');
            
            if (archivoNombre) archivoNombre.textContent = file.name;
            if (archivoTama√±o) archivoTama√±o.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB - ${file.type}`;
            if (archivoInfo) archivoInfo.classList.remove('hidden');
        }

        function limpiarArchivo() {
            const archivoInput = document.getElementById('archivoIA');
            const archivoInfo = document.getElementById('archivoInfo');
            const resultados = document.getElementById('resultadosAnalisisIA');
            
            if (archivoInput) archivoInput.value = '';
            if (archivoInfo) archivoInfo.classList.add('hidden');
            if (resultados) resultados.classList.add('hidden');
            habilitarBotonAnalisis(false);
        }

        function habilitarBotonAnalisis(habilitar) {
            const btn = document.getElementById('btnAnalizarArchivo');
            if (btn) btn.disabled = !habilitar;
        }

        async function analizarArchivoIA() {
            const archivoInput = document.getElementById('archivoIA');
            const btn = document.getElementById('btnAnalizarArchivo');
            const btnTexto = document.getElementById('btnTexto');
            const resultados = document.getElementById('resultadosAnalisisIA');
            
            if (!archivoInput?.files[0]) {
                showToast('Por favor selecciona un archivo', 'error');
                return;
            }
            
            const file = archivoInput.files[0];
            
            try {
                // Mostrar estado de carga
                if (btn) btn.disabled = true;
                if (btnTexto) {
                    btnTexto.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Analizando...';
                    lucide.createIcons();
                }
                
                // Crear FormData para env√≠o
                const formData = new FormData();
                formData.append('archivo', file);
                
                // Enviar al backend
                const response = await fetch(`${API_BASE}/ingesta/analizar-archivo`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Mostrar resultados
                mostrarResultadosAnalisis(data);
                if (resultados) resultados.classList.remove('hidden');
                
                showToast('Archivo analizado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error analizando archivo:', error);
                showToast(`Error analizando archivo: ${error.message}`, 'error');
            } finally {
                // Restaurar bot√≥n
                if (btn) btn.disabled = false;
                if (btnTexto) {
                    btnTexto.innerHTML = '<i data-lucide="brain" class="w-4 h-4 inline mr-2"></i>Analizar con IA';
                    lucide.createIcons();
                }
            }
        }

        function mostrarResultadosAnalisis(data) {
            const contenido = document.getElementById('contenidoAnalisisIA');
            if (!contenido) return;
            
            const analisis = data.analisis_ia;
            
            let html = `
                <div class="space-y-4">
                    <!-- Informaci√≥n del archivo -->
                    <div class="bg-gray-800/50 p-4 rounded-lg">
                        <h5 class="font-semibold text-cyan-400 mb-2">üìÑ Informaci√≥n del Archivo</h5>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-gray-400">Nombre:</span> <span class="text-white">${data.archivo.nombre}</span></div>
                            <div><span class="text-gray-400">Tama√±o:</span> <span class="text-white">${data.archivo.tama√±o_mb} MB</span></div>
                            <div><span class="text-gray-400">Tipo:</span> <span class="text-white">${data.archivo.tipo}</span></div>
                            <div><span class="text-gray-400">Estado:</span> <span class="text-green-400">${data.estado}</span></div>
                        </div>
                    </div>
                    
                    <!-- Resumen del an√°lisis -->
                    <div class="bg-purple-900/30 p-4 rounded-lg border border-purple-500/30">
                        <h5 class="font-semibold text-purple-400 mb-2">üß† An√°lisis de IA</h5>
                        <p class="text-sm text-gray-300 mb-3">${analisis.resumen_ia?.texto_relevante || 'Documento procesado exitosamente'}</p>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-gray-400">Tipo detectado:</span> <span class="text-white">${analisis.tipo_documento}</span></div>
                            <div><span class="text-gray-400">Calidad:</span> <span class="text-green-400">${analisis.resumen_ia?.calidad_datos || 'N/A'}</span></div>
                        </div>
                    </div>
            `;
            
            // Mostrar datos extra√≠dos si existen
            if (analisis.datos_extraidos && analisis.datos_extraidos.length > 0) {
                html += `
                    <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
                        <h5 class="font-semibold text-blue-400 mb-3">üìä Datos Extra√≠dos (${analisis.datos_extraidos.length} registros)</h5>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="text-left p-2">Establecimiento</th>
                                        <th class="text-left p-2">Comuna</th>
                                        <th class="text-left p-2">Dimensi√≥n</th>
                                        <th class="text-left p-2">Promedio</th>
                                        <th class="text-left p-2">Confianza</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                analisis.datos_extraidos.slice(0, 5).forEach(dato => {
                    html += `
                        <tr class="border-t border-gray-700">
                            <td class="p-2 text-white">${dato.establecimiento}</td>
                            <td class="p-2 text-gray-300">${dato.comuna}</td>
                            <td class="p-2 text-cyan-400">${dato.dimension}</td>
                            <td class="p-2 text-green-400">${dato.promedio}</td>
                            <td class="p-2 text-yellow-400">${(dato.confianza_extraccion * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
                
                if (analisis.datos_extraidos.length > 5) {
                    html += `
                        <tr class="border-t border-gray-700">
                            <td colspan="5" class="p-2 text-gray-400 text-center">... y ${analisis.datos_extraidos.length - 5} registros m√°s</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div></div>';
            }
            
            // Mostrar recomendaciones si existen
            if (analisis.resumen_ia?.recomendaciones) {
                html += `
                    <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
                        <h5 class="font-semibold text-yellow-400 mb-2">üí° Recomendaciones</h5>
                        <ul class="text-sm text-gray-300 space-y-1">
                `;
                analisis.resumen_ia.recomendaciones.forEach(rec => {
                    html += `<li class="flex items-start"><span class="text-yellow-400 mr-2">‚Ä¢</span>${rec}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            contenido.innerHTML = html;
        }

        // Funciones para manejo de an√°lisis de archivos con IA
        function setupArchivoHandlers() {
            const archivoInput = document.getElementById('archivoIA');
            const dropzone = document.getElementById('archivoDropzone');
            
            if (!archivoInput || !dropzone) return;
            
            // Manejar selecci√≥n de archivo
            archivoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    mostrarInfoArchivo(file);
                    habilitarBotonAnalisis(true);
                }
            });
            
            // Manejar drag & drop
            dropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropzone.classList.add('border-accent-cyan/80');
            });
            
            dropzone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropzone.classList.remove('border-accent-cyan/80');
            });
            
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('border-accent-cyan/80');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    archivoInput.files = files;
                    mostrarInfoArchivo(files[0]);
                    habilitarBotonAnalisis(true);
                }
            });
        }

        function mostrarInfoArchivo(file) {
            const archivoInfo = document.getElementById('archivoInfo');
            const archivoNombre = document.getElementById('archivoNombre');
            const archivoTama√±o = document.getElementById('archivoTama√±o');
            
            if (archivoInfo && archivoNombre && archivoTama√±o) {
                archivoNombre.textContent = file.name;
                archivoTama√±o.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB - ${file.type}`;
                archivoInfo.classList.remove('hidden');
            }
        }

        function limpiarArchivo() {
            const archivoInput = document.getElementById('archivoIA');
            const archivoInfo = document.getElementById('archivoInfo');
            const resultados = document.getElementById('resultadosAnalisisIA');
            
            if (archivoInput) archivoInput.value = '';
            if (archivoInfo) archivoInfo.classList.add('hidden');
            if (resultados) resultados.classList.add('hidden');
            habilitarBotonAnalisis(false);
        }

        function habilitarBotonAnalisis(habilitar) {
            const btn = document.getElementById('btnAnalizarArchivo');
            if (btn) {
                btn.disabled = !habilitar;
            }
        }

        async function analizarArchivoIA() {
            const archivoInput = document.getElementById('archivoIA');
            const btn = document.getElementById('btnAnalizarArchivo');
            const btnTexto = document.getElementById('btnTexto');
            const resultados = document.getElementById('resultadosAnalisisIA');
            const contenido = document.getElementById('contenidoAnalisisIA');
            
            console.log('Iniciando an√°lisis de archivo...');
            
            if (!archivoInput?.files[0]) {
                showToast('Por favor selecciona un archivo', 'error');
                return;
            }
            
            const file = archivoInput.files[0];
            console.log('Archivo seleccionado:', file.name, file.type, file.size);
            
            try {
                // Mostrar estado de carga
                if (btn) btn.disabled = true;
                if (btnTexto) {
                    btnTexto.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Analizando...';
                    lucide.createIcons();
                }
                
                // Crear FormData para env√≠o
                const formData = new FormData();
                formData.append('archivo', file);
                
                console.log('Enviando al backend...');
                
                // Enviar al backend
                const response = await fetch(`${API_BASE}/ingesta/analizar-archivo`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Respuesta del backend:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error del backend:', errorText);
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                // Mostrar resultados
                if (contenido) {
                    mostrarResultadosAnalisis(data);
                }
                if (resultados) {
                    resultados.classList.remove('hidden');
                }
                
                showToast('Archivo analizado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error analizando archivo:', error);
                showToast(`Error analizando archivo: ${error.message}`, 'error');
            } finally {
                // Restaurar bot√≥n
                if (btn) btn.disabled = false;
                if (btnTexto) {
                    btnTexto.innerHTML = '<i data-lucide="brain" class="w-4 h-4 inline mr-2"></i>Analizar con IA';
                    lucide.createIcons();
                }
            }
        }

        function updateEntidadOptions() {
            const entidadTipo = document.getElementById('entidadProyeccion')?.value;
            const codigoEntidadSelect = document.getElementById('codigoEntidad');
            
            if (!codigoEntidadSelect) return;
            
            codigoEntidadSelect.innerHTML = '<option value="">Cargando...</option>';
            
            if (entidadTipo === 'colegio') {
                // Cargar establecimientos
                loadColegios().then(() => {
                    const colegios = currentData.colegios || COLEGIOS_AYSEN;
                    codigoEntidadSelect.innerHTML = '<option value="">Seleccionar establecimiento...</option>';
                    colegios.forEach(colegio => {
                        const option = document.createElement('option');
                        option.value = colegio.rbd;
                        option.textContent = `${colegio.nombre} - ${colegio.comuna}`;
                        codigoEntidadSelect.appendChild(option);
                    });
                });
            } else if (entidadTipo === 'comuna') {
                // Cargar comunas
                codigoEntidadSelect.innerHTML = '<option value="">Seleccionar comuna...</option>';
                COMUNAS_AYSEN.forEach(comuna => {
                    const option = document.createElement('option');
                    option.value = comuna.codigo;
                    option.textContent = comuna.nombre;
                    codigoEntidadSelect.appendChild(option);
                });
            }
        }

        // Funciones para gesti√≥n de dimensiones DIA
        async function actualizarDimensiones() {
            const colegioSelect = document.getElementById('colegiosDimensionSelect');
            const nivelSelect = document.getElementById('nivelDimensionSelect');
            
            const colegioRBD = colegioSelect?.value || '';
            const nivel = nivelSelect?.value || '';
            
            try {
                // Primero verificar que el endpoint de dimensiones existe
                const testResponse = await fetch(`${API_BASE}/dimensiones`);
                if (!testResponse.ok) {
                    throw new Error('Endpoint de dimensiones no disponible');
                }
                
                // Cargar datos de todas las dimensiones
                const dimensiones = ['PA', 'FVA', 'AA', 'ANS', 'CD'];
                const promesas = dimensiones.map(async (codigo) => {
                    try {
                        const response = await fetch(`${API_BASE}/dimensiones/detalle/${codigo}?colegio_rbd=${colegioRBD}&nivel=${nivel}`);
                        if (!response.ok) {
                            console.warn(`Error cargando dimensi√≥n ${codigo}: ${response.status}`);
                            return { codigo, data: null, error: true };
                        }
                        const data = await response.json();
                        return { codigo, data, error: false };
                    } catch (error) {
                        console.error(`Error en dimensi√≥n ${codigo}:`, error);
                        return { codigo, data: null, error: true };
                    }
                });
                
                const resultados = await Promise.all(promesas);
                const resultadosValidos = resultados.filter(r => !r.error && r.data);
                
                if (resultadosValidos.length === 0) {
                    throw new Error('No se pudieron cargar las dimensiones');
                }
                
                // Actualizar KPIs superiores
                resultadosValidos.forEach(({ codigo, data }) => {
                    actualizarKPIDimension(codigo, data);
                });
                
                // Solo actualizar gr√°ficos si tenemos datos v√°lidos
                if (resultadosValidos.length > 0) {
                    await actualizarGraficosComparativos(resultadosValidos);
                    
                    // Actualizar gr√°ficos individuales por dimensi√≥n
                    for (const { codigo, data } of resultadosValidos) {
                        await actualizarGraficoIndividual(codigo, data);
                    }
                }
                
                showToast('Dimensiones actualizadas correctamente', 'success');
                
            } catch (error) {
                console.error('Error actualizando dimensiones:', error);
                showToast(`Error al actualizar dimensiones: ${error.message}`, 'error');
                
                // Cargar datos de respaldo
                cargarDatosRespaldoDimensiones();
            }
        }

        function cargarDatosRespaldoDimensiones() {
            // Datos de respaldo para mostrar algo en caso de error
            const datosRespaldo = {
                'PA': { promedio_general: 3.8, total_estudiantes: 245 },
                'FVA': { promedio_general: 4.1, total_estudiantes: 234 },
                'AA': { promedio_general: 3.5, total_estudiantes: 256 },
                'ANS': { promedio_general: 2.9, total_estudiantes: 267 },
                'CD': { promedio_general: 4.3, total_estudiantes: 223 }
            };
            
            Object.entries(datosRespaldo).forEach(([codigo, data]) => {
                actualizarKPIDimension(codigo, data);
            });
        }

        function actualizarKPIDimension(codigo, data) {
            const elementos = {
                'PA': { score: 'promocioPAScore', promedio: 'promocioPAPromedio', estudiantes: 'promocioPAEstudiantes' },
                'FVA': { score: 'vinculoFVAScore', promedio: 'vinculoFVAPromedio', estudiantes: 'vinculoFVAEstudiantes' },
                'AA': { score: 'autorregulacionAAScore', promedio: 'autorregulacionAAPromedio', estudiantes: 'autorregulacionAAEstudiantes' },
                'ANS': { score: 'ansiedadANSScore', promedio: 'ansiedadANSPromedio', estudiantes: 'ansiedadANSEstudiantes' },
                'CD': { score: 'ciudadaniaCDScore', promedio: 'ciudadaniaCDPromedio', estudiantes: 'ciudadaniaCDEstudiantes' }
            };
            
            const ids = elementos[codigo];
            if (!ids) return;
            
            // Actualizar elementos del DOM
            const scoreElement = document.getElementById(ids.score);
            const promedioElement = document.getElementById(ids.promedio);
            const estudiantesElement = document.getElementById(ids.estudiantes);
            
            if (scoreElement) scoreElement.textContent = data.promedio_general;
            if (promedioElement) promedioElement.textContent = data.promedio_general;
            if (estudiantesElement) estudiantesElement.textContent = data.total_estudiantes;
        }

        async function actualizarGraficosComparativos(resultados) {
            // Verificar que Chart.js est√© disponible
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible');
                return;
            }
            
            // Gr√°fico comparativo de dimensiones
            const canvas1 = document.getElementById('dimensionesComparativaChart');
            if (canvas1 && resultados.length > 0) {
                try {
                    const ctx1 = canvas1.getContext('2d');
                    
                    if (window.dimensionesComparativaInstance) {
                        window.dimensionesComparativaInstance.destroy();
                    }
                    
                    const labels = resultados.map(r => r.data?.dimension?.nombre || 'Sin datos');
                    const promedios = resultados.map(r => r.data?.promedio_general || 0);
                    
                    window.dimensionesComparativaInstance = new Chart(ctx1, {
                        type: 'radar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Promedio por Dimensi√≥n',
                                data: promedios,
                                backgroundColor: 'rgba(0, 212, 255, 0.2)',
                                borderColor: '#00D4FF',
                                borderWidth: 2,
                                pointBackgroundColor: '#00D4FF',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#00D4FF'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: 'white' } }
                            },
                            scales: {
                                r: {
                                    min: 1,
                                    max: 5,
                                    ticks: { color: 'white' },
                                    grid: { color: '#374151' },
                                    angleLines: { color: '#374151' },
                                    pointLabels: { color: 'white', font: { size: 10 } }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creando gr√°fico comparativo:', error);
                }
            }
            
            // Gr√°fico por niveles (usando primera dimensi√≥n como ejemplo)
            const canvas2 = document.getElementById('dimensionesNivelesChart');
            if (canvas2 && resultados.length > 0 && resultados[0].data?.datos_por_nivel) {
                try {
                    const ctx2 = canvas2.getContext('2d');
                    
                    if (window.dimensionesNivelesInstance) {
                        window.dimensionesNivelesInstance.destroy();
                    }
                    
                    const primeraData = resultados[0].data;
                    const labels = primeraData.datos_por_nivel.map(n => n.nivel);
                    const promedios = primeraData.datos_por_nivel.map(n => n.promedio);
                    const estudiantes = primeraData.datos_por_nivel.map(n => n.cantidad_estudiantes);
                    
                    window.dimensionesNivelesInstance = new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Promedio',
                                    data: promedios,
                                    borderColor: '#FF8A00',
                                    backgroundColor: 'rgba(255, 138, 0, 0.1)',
                                    borderWidth: 3,
                                    yAxisID: 'y',
                                    tension: 0.4
                                },
                                {
                                    label: 'Estudiantes',
                                    data: estudiantes,
                                    borderColor: '#10B981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 2,
                                    yAxisID: 'y1',
                                    type: 'bar',
                                    borderRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: 'white' } }
                            },
                            scales: {
                                x: { ticks: { color: 'white' }, grid: { color: '#374151' } },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    ticks: { color: 'white' },
                                    grid: { color: '#374151' },
                                    min: 1,
                                    max: 5,
                                    title: { display: true, text: 'Promedio (1-5)', color: 'white' }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    ticks: { color: 'white' },
                                    grid: { drawOnChartArea: false },
                                    title: { display: true, text: 'Estudiantes', color: 'white' }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creando gr√°fico por niveles:', error);
                }
            }
        }

        async function actualizarGraficoIndividual(codigo, data) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible para gr√°fico individual');
                return;
            }
            
            if (!data || !data.datos_por_nivel) {
                console.warn(`No hay datos para la dimensi√≥n ${codigo}`);
                return;
            }
            
            // Mapear c√≥digos a nombres de canvas corregidos
            const canvasMapping = {
                'PA': 'promocioPAChart',
                'FVA': 'vinculoFVAChart', 
                'AA': 'autorregulacionAAChart',
                'ANS': 'ansiedadANSChart',
                'CD': 'ciudadaniaCDChart'
            };
            
            const canvasId = canvasMapping[codigo];
            if (!canvasId) {
                console.warn(`No se encontr√≥ canvas para dimensi√≥n ${codigo}`);
                return;
            }
            
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(`Canvas ${canvasId} no encontrado en DOM`);
                return;
            }
            
            try {
                const ctx = canvas.getContext('2d');
                const instanceName = `${canvasId}Instance`;
                
                if (window[instanceName]) {
                    window[instanceName].destroy();
                }
                
                const labels = data.datos_por_nivel.map(n => n.nivel);
                const promedios = data.datos_por_nivel.map(n => n.promedio);
                
                // Colores espec√≠ficos por dimensi√≥n
                const colores = {
                    'PA': '#FF8A00',
                    'FVA': '#00D4FF', 
                    'AA': '#10B981',
                    'ANS': '#EF4444',
                    'CD': '#8B5CF6'
                };
                
                window[instanceName] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${data.dimension.nombre}`,
                            data: promedios,
                            backgroundColor: colores[codigo] + '40',
                            borderColor: colores[codigo],
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: 'white' } }
                        },
                        scales: {
                            y: {
                                ticks: { color: 'white' },
                                grid: { color: '#374151' },
                                min: 1,
                                max: 5,
                                title: { display: true, text: 'Promedio (1-5)', color: 'white' }
                            },
                            x: { 
                                ticks: { color: 'white', maxRotation: 45 },
                                grid: { color: '#374151' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creando gr√°fico individual para ${codigo}:`, error);
            }
        }

        // Cargar colegios en el selector de dimensiones
        async function cargarColegiosDimensiones() {
            try {
                const response = await fetch(`${API_BASE}/colegios`);
                const data = await response.json();
                
                const select = document.getElementById('colegiosDimensionSelect');
                if (select) {
                    select.innerHTML = '<option value="">Todos los colegios</option>';
                    data.colegios.forEach(colegio => {
                        const option = document.createElement('option');
                        option.value = colegio.rbd;
                        option.textContent = `${colegio.nombre} - ${colegio.comuna}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando colegios para dimensiones:', error);
            }
        }

        // Cargar datos geogr√°ficos de Ays√©n
        async function loadGeografiaAysen() {
            try {
                // Cargar comunas
                const comunasResponse = await fetch(`${API_BASE}/geografia/comunas`);
                if (comunasResponse.ok) {
                    const comunasData = await comunasResponse.json();
                    
                    // Llenar selector de filtros si existe
                    const filtroComuna = document.getElementById('filtroComuna');
                    if (filtroComuna) {
                        filtroComuna.innerHTML = '<option value="">Todas las comunas</option>';
                        if (comunasData.comunas) {
                            comunasData.comunas.forEach(comuna => {
                                const option = document.createElement('option');
                                option.value = comuna.nombre;
                                option.textContent = comuna.nombre;
                                filtroComuna.appendChild(option);
                            });
                        }
                    }
                }
                
                // Cargar localidades
                const localidadesResponse = await fetch(`${API_BASE}/geografia/localidades`);
                if (localidadesResponse.ok) {
                    const localidadesData = await localidadesResponse.json();
                    
                    // Llenar selector de localidades si existe
                    const filtroLocalidad = document.getElementById('filtroLocalidad');
                    if (filtroLocalidad) {
                        filtroLocalidad.innerHTML = '<option value="">Todas las localidades</option>';
                        if (localidadesData.localidades) {
                            localidadesData.localidades.forEach(localidad => {
                                const option = document.createElement('option');
                                option.value = localidad.nombre;
                                option.textContent = `${localidad.nombre} - ${localidad.comuna}`;
                                filtroLocalidad.appendChild(option);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando geograf√≠a de Ays√©n:', error);
            }
        }

        // Inicializaci√≥n - Agregar handlers de archivos
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            showSection('dashboard');
            
            // Esperar a que Chart.js se cargue completamente
            function waitForChart() {
                if (typeof Chart !== 'undefined') {
                    console.log('Chart.js disponible, iniciando aplicaci√≥n...');
                    initializeApp();
                } else {
                    console.log('Esperando Chart.js...');
                    setTimeout(waitForChart, 100);
                }
            }
            
            waitForChart();
        });

        async function initializeApp() {
            try {
                // Verificar conexi√≥n con el backend
                await checkBackendConnection();
                
                await loadInitialData();
                await loadColegios();
                await loadGeografiaAysen();
                await cargarColegiosDimensiones();
                
                // Configurar handlers de an√°lisis de archivos IA
                setTimeout(() => {
                    setupArchivoHandlers();
                }, 500);
                
                console.log('Aplicaci√≥n inicializada correctamente');
                updateConnectionStatus('Conectado', true);
            } catch (error) {
                console.error('Error inicializando aplicaci√≥n:', error);
                handleApiError(error, 'initializeApp');
            }
        }

        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`, { 
                    method: 'GET',
                    timeout: 5000
                });
                if (!response.ok) {
                    throw new Error(`Backend no disponible: ${response.status}`);
                }
                const data = await response.json();
                console.log('Conexi√≥n con backend establecida:', data);
                isBackendConnected = true;
                retryCount = 0; // Reset retry count on successful connection
                return true;
            } catch (error) {
                console.error('Error conectando con backend:', error);
                isBackendConnected = false;
                throw error;
            }
        }

        function updateConnectionStatus(message, isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full mr-2 ${isConnected ? 'bg-green-500' : 'bg-red-500'}"></div>
                        <span class="text-xs">${message}</span>
                    </div>
                `;
            }
        }

        // Funci√≥n de recarga de datos
        async function refreshData() {
            console.log('Refrescando datos...');
            updateConnectionStatus('Reconectando...', false);
            
            try {
                retryCount = 0; // Reset retry count
                await checkBackendConnection();
                await loadInitialData();
                updateConnectionStatus('Conectado', true);
                showToast('Datos actualizados correctamente', 'success');
            } catch (error) {
                console.error('Error al refrescar datos:', error);
                updateConnectionStatus('Error de conexi√≥n', false);
                showToast('Error al actualizar datos', 'error');
            }
        }
    </script>
</body>
</html>